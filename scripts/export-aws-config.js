const { CloudFormationClient, DescribeStacksCommand } = require('@aws-sdk/client-cloudformation');
const fs = require('fs');
const path = require('path');

// ‚úÖ Get region from AWS config or environment
const region = process.env.AWS_REGION || process.env.AWS_DEFAULT_REGION || 'eu-north-1';

const client = new CloudFormationClient({ region });

async function exportConfig(environment) {
  console.log(`üì¶ Exporting AWS configuration for ${environment}...`);
  console.log(`üìç Using region: ${region}`);

  try {
    const prefix = `PREPG3-${environment}`;
    
    const authStack = await client.send(
      new DescribeStacksCommand({ StackName: `${prefix}-Auth` })
    );
    
    const apiStack = await client.send(
      new DescribeStacksCommand({ StackName: `${prefix}-API` })
    );
    
    const storageStack = await client.send(
      new DescribeStacksCommand({ StackName: `${prefix}-Storage` })
    );

    const getOutput = (stack, key) => {
      return stack.Stacks?.[0]?.Outputs?.find((o) => o.OutputKey === key)?.OutputValue;
    };

    const config = {
      Auth: {
        Cognito: {
          userPoolId: getOutput(authStack, 'UserPoolId'),
          userPoolClientId: getOutput(authStack, 'UserPoolClientId'),
          identityPoolId: getOutput(authStack, 'IdentityPoolId'),
        },
      },
      API: {
        GraphQL: {
          endpoint: getOutput(apiStack, 'GraphQLApiUrl'),
          region: region, // ‚úÖ Use detected region
          defaultAuthMode: 'userPool',
        },
      },
      Storage: {
        S3: {
          bucket: getOutput(storageStack, 'DocumentsBucketName'),
          region: region, // ‚úÖ Use detected region
        },
      },
    };

    const configPath = path.join(__dirname, '../../apps/shared/config/aws-exports.js');
    const configContent = `// Auto-generated by export-aws-config.js - DO NOT EDIT MANUALLY
// Generated: ${new Date().toISOString()}
// Environment: ${environment}
// Region: ${region}

export const awsConfig = ${JSON.stringify(config, null, 2)};
`;

    fs.mkdirSync(path.dirname(configPath), { recursive: true });
    fs.writeFileSync(configPath, configContent);

    console.log('‚úÖ Configuration exported to apps/shared/config/aws-exports.js');
    console.log(`‚úÖ Region: ${region}`);
    console.log('\nConfiguration:');
    console.log(JSON.stringify(config, null, 2));

  } catch (error) {
    console.error('‚ùå Error exporting configuration:', error.message);
    
    if (error.name === 'ResourceNotFoundException') {
      console.error('\nüí° Stack not found. Make sure you have deployed the infrastructure first:');
      console.error('   cd infrastructure && npm run deploy');
    }
    
    process.exit(1);
  }
}

const environment = process.argv[2] || 'live';
exportConfig(environment);